
// //  // Q1 (Upper Right) - 11, 12, 13, 14, 15, 16, 17, 18
//    '1-8': "M33,314.3 L38,325.7 L45.7,335.7 L55.7,341.7 L64.7,343 L73.3,340 L77.7,335.7 L81.3,326.3 L82,314.3 L81.3,302 L80.7,292.7 L73.7,292 L51.3,293.7 L38.7,293.7 L34,298 L31.7,302.3 L32,311 Z",
//     '1-7': "M79.7,288.3 L71.7,291 L55,293 L40.3,291.3 L36,287 L33,273.7 L36.3,260 L42,248.7 L44.7,244.7 L50.3,246.7 L56,249 L65.3,250.7 L74,249.7 L80.3,249.7 L82.3,254 L85.3,259.3 L87,267.7 L87.7,274.7 L85.3,282.7 Z",
//     '1-6': "M92.7,207.3 L94.7,212.6 L93,220.6 L91.3,229.6 L87.3,237.6 L82.3,245.3 L71.3,250 L57.6,250.7 L47.6,243.7 L45.9,238.7 L45,220 L48,209.3 L53,202 L57,198.7 L61.7,196 L67,199.7 L73.7,201 L81,201 L87.3,201.7 L92.7,203.7 Z",
//     '1-5': "M82,155.3 L102.3,163.3 L108.7,172 L109.3,182 L104.7,192 L100,199 L94,203.7 L85.3,201.7 L73.7,201 L64.3,196.7 L60.3,190.7 L59,183.3 L61.7,175.3 L66.3,167.7 L71.3,161.3 Z",
//     '1-4': "M109,116.7 L116,122.3 L122.7,125.3 L127.7,131.3 L128.3,141 L122.7,153.7 L114,161.7 L105.7,162.3 L96.7,161 L85.7,156 L82,150 L81,139.3 L86.3,128 L93,121.3 L100.7,117.3 Z",
//     '1-3': "M126.3,82 L134.3,86.3 L139.7,92.3 L144.7,104.7 L145.7,115.3 L143.7,120.7 L138,124.3 L131.3,125 L121,125 L114.7,119.3 L110.3,112.3 L108.3,104.7 L108.7,94.7 L110.7,88.7 L116,84 Z",
//     '1-2': "M167,55 L173.7,61.3 L174,68 L174.3,76 L175.3,86 L173.3,94.3 L168.6,98.6 L161.9,100.3 L153.9,96 L146.6,91.3 L137.3,86.6 L131,81.3 L130,77 L131.3,72 L135.6,66 L141.9,60 L152.2,55.3 L162.5,55 Z",
//     '1-1': "M176.7,46.3 L195,41 L203.3,39.7 L209.3,40.7 L215.3,42.7 L217,47 L217.7,54.3 L215,64.7 L212.3,75.7 L208,83 L201.7,85.7 L195.7,86.7 L189.7,83.3 L183.7,74.7 L175,62 L171.7,54 L172.7,49.7 Z",

//     // Q2 (Upper Left) - 21, 22, 23, 24, 25, 26, 27, 28
//     '2-1': "M273.3,52 L266.7,61.7 L258.3,72.3 L253.3,79.7 L247.3,85 L239,87.7 L232.3,82 L224.7,67 L222,58.3 L219,50 L220,44.3 L224.3,40.3 L230,38.7 L237.3,38.7 L253,39.3 L258.7,41.3 L264.3,43.7 L268.3,45.7 Z",
//     '2-2': "M310.3,83.3 L298,90.7 L286,95 L276.3,98.3 L270.3,93.3 L269,82.7 L269,69.3 L270,58.7 L274.7,54.7 L282,53 L287.7,54.7 L297.3,60.3 L304,64.3 L308.7,68.7 L312.3,74 L313,81 Z",
//     '2-3': "M336,93.3 L337.7,100 L336,104.7 L332.7,113.7 L324.3,121.3 L315.3,125.7 L306.3,126 L297.3,120.3 L294,112 L295.7,102.7 L299,95 L303.3,90 L309.3,88 L316.3,87.3 L322.7,87.3 L328,88.3 Z",
//     '2-4': "M358.7,134.3 L360.3,145.7 L357.3,152.7 L352,157.3 L346.3,161 L336,164 L329.7,163.3 L321.7,157.7 L314.3,149 L310.7,139.3 L310,133.7 L312.3,127 L318.3,125.7 L326,122 L332.7,116 L334.7,114.3 L337.7,117.3 L343.3,119.7 L348.7,122.7 L354.3,127.7 Z",
//     '2-5': "M386,188.7 L383.3,192.7 L377.7,196 L356.3,203.3 L345.7,202.3 L341.7,199.7 L338.7,196.3 L335,188.7 L332,177 L333.7,169.7 L338,164.7 L346.3,161 L353.7,156.7 L360.3,150.3 L364,151 L370.7,156.3 L376.3,164.3 L380,170.3 L383.3,178.3 Z",
//     '2-6': "M359.7,243.7 L350.7,224 L345.7,211.7 L348.7,205 L358.3,202.7 L375.7,197 L388.7,193 L393,196 L399.3,207 L401.3,222.7 L400,234.3 L394.7,240.7 L381.7,244.7 L371,246 Z",
//     '2-7': "M362.3,247.3 L357.3,251 L357,259.3 L358.7,268 L359.7,279.7 L361.3,286.7 L365,291.7 L371,294.3 L392,295 L404.3,293.7 L410,280.7 L412,263.3 L407.3,246.7 L401,240.3 L396,239.7 L389.3,243 Z",
//     '2-8': "M404.3,293.7 L408.7,299.3 L408.7,308 L405.3,318.7 L401,329.7 L392.3,339.7 L382.7,341 L369,339.7 L359,335 L354.7,327.7 L354.3,316 L358.3,304 L363.7,294 L368.7,294.7 L378.7,296 L389,296 Z",

//     // Q3 (Lower Left) - 31, 32, 33, 34, 35, 36, 37, 38
//     '3-1': "M371.7,417 L378.3,417.3 L386.7,415.7 L391.7,415.3 L397.3,417.7 L402.7,416.3 L407.7,409.7 L406.7,395 L401,377.7 L397.3,373 L390.7,367.3 L380,365 L373,366.7 L367.3,369 L364,374.3 L360,389 L363.3,401.3 L367.7,412.3 Z",
//     '3-2': "M410,435 L408.7,447.3 L404.3,459 L399.3,467.7 L393.7,468 L388,466 L376.3,466.3 L369.7,466.3 L365.7,460 L364.7,444.7 L366.3,434.3 L369,424 L378.3,417.3 L386.7,415.7 L391.7,415.3 L396,418 L399.7,418 L404,421.7 L407.7,427.3 Z",
//     '3-3': "M398,470 L402.7,475.7 L405.7,483.4 L405.4,495.1 L399.4,508.4 L393.1,518.7 L384.8,523 L377.5,522 L361.2,515 L358.2,508 L357.9,497 L361.6,482.7 L365.3,475.7 L370.6,469 L378.6,467 L388.3,467.3 Z",
//     '3-4': "M334,561 L338.7,566 L346,570 L354.7,573 L360.7,571.7 L368,568.3 L383,545 L385.3,532.7 L381.3,524.3 L374,520.7 L363.7,516.3 L356.3,515.3 L351.3,518.3 L346.3,524 L340.3,534.3 L336,546.7 Z",
//     '3-5': "M331,565.7 L335,565.7 L341.3,568 L349.3,574.3 L352.3,578.3 L352.7,583.7 L350.7,593.7 L342.7,604 L337.7,609 L328,612.7 L320,613.3 L315,611 L308.3,604.7 L306.7,598 L307.3,591.3 L309,584.7 L312.7,578.3 L318.3,571.7 Z",
//     '3-6': "M286,629.3 L286.7,633.3 L291.3,638.7 L295.3,642.3 L302,644 L311.7,643.3 L318.3,637.7 L321,630 L321.3,620.3 L317,614.3 L308,608 L298.3,607 L291,609.3 L287,612.3 L286.7,617.7 L287.3,624.7 Z",
//     '3-7': "M269.3,624 L273.3,624.7 L275.3,627.3 L279,628.7 L281.7,631.3 L285.3,634.7 L289.3,638.3 L292,643.3 L291.3,650 L287,655 L280.7,658.7 L272,660 L265,660.7 L261.3,657.3 L261.7,650 L263.7,637 L264.3,627 Z",
//     '3-8': "M235.3,637 L239.3,634.7 L243.3,634.7 L248.6,639 L253.9,646.3 L257.2,653.6 L257.2,660.3 L249.5,663 L239.5,663.3 L229.5,663.3 L227.5,656.6 L230.2,649.3 Z",

//     '4-1': "M214,637 L218,642.7 L223,654.3 L225.7,664 L225.3,666.3 L219,668.3 L206.7,668 L196,665.7 L190.3,662.7 L193,657.3 L199.7,647.3 L207,638 L210.7,635.5 Z",
//     '4-2': "M178.3,627 L186,629 L187.7,633.7 L188.7,644 L189,657 L189.3,662.7 L186.3,663.7 L176.7,663 L168,656.3 L159.3,649.7 L156.7,644 L162,639.3 Z",
//     '4-3': "M155.7,611 L160.3,615.3 L165,624.7 L161.7,634.3 L156,641.3 L149,644 L140.7,644.3 L133.3,641.3 L128.7,634.7 L128.7,629 L132.7,621.3 L137.7,615 L143.7,611 L149.7,610 Z",
//     '4-4': "M117.3,569.7 L125,571 L131.3,574.7 L137.6,582.4 L141.6,590.7 L143.3,602 L142,608.7 L135.3,615.4 L127.6,618.7 L120.3,617.7 L113.3,614.7 L106,607.7 L101,598.7 L99,588.7 L99.3,581.4 L100.6,574.7 L106,568 L112.3,563 Z",
//     '4-5': "M93.3,525 L99.3,527.3 L108.3,536 L114,546.7 L115.7,559.3 L114.3,567.3 L106.3,573 L98.3,578.3 L88,579 L82,575 L75,565 L69.3,552.3 L67.3,542 L69.7,536 L74.3,531.7 L84.3,528.3 Z",
//     '4-6': "M78.7,476 L85,481 L90.3,488.3 L96.3,499.3 L97.7,511.3 L93,522 L86,526.3 L67,533 L60.3,529.7 L56.3,523.7 L51.7,511 L47.7,494.7 L47.7,488.3 L50.3,483.3 L55,479.7 L67,476.7 Z",
//     '4-7': "M76,425.7 L80.3,427.7 L83.3,433 L85.3,447.7 L84.3,458.7 L79.7,472.3 L73,475 L50.3,479.7 L46.7,476.7 L37.7,446.3 L39.7,438.3 L43.3,432 L49,426.7 L56,424.7 L65,424.7 Z",
//     '4-8': "M66.7,369.7 L59,370.3 L51,373.7 L43.7,384.3 L42.3,392 L38.7,406 L41,415.3 L44.3,420.3 L47.3,424 L51.7,424.3 L57.7,424 L62.3,422.7 L66.7,422.7 L71,424.3 L76.3,422.7 L80.7,419.3 L84.7,412.3 L85.3,405 L87.3,391.7 L85,380 L80.7,375 L73.7,371.3 Z"

  // A: "M55.2,236.1 L60,237.2 L69.8,240.2 L86.9,243.3 L92,247 L95.7,255.8 L95.7,271.2 L94.7,286.5 L90.2,305.2 L82.8,312.8 L72,318.5 L56.7,319.3 L48.8,317.5 L40.8,311.5 L33,300.3 L31.3,284.7 L34.2,273.8 L39.3,256.3 L42.3,248 Z",
  //   B: "M90.2,242.2 L97.3,236.1 L106.3,224.2 L114.9,200.1 L117.3,189.4 L113,179.1 L95.7,169.8 L86.2,169.8 L71.9,179.1 L63.5,191.3 L58.6,202.5 L54,215.2 L55.8,227.2 L65.8,238.9 L79.1,242.2 Z",
  //   C: "M106.7,132.2 L118,132.2 L130.3,132.5 L139.7,138.2 L144.7,147.8 L144.7,160.8 L134.3,173.8 L121.7,180.2 L115,180.2 L107.7,174.5 L100,169.8 L98.7,156.8 L97.3,147.8 L98.3,138.8 L104.7,133.2 Z",
  //   D: "M123.7,124.2 L131.3,131.2 L143.3,137.5 L151.3,141.8 L159,142.5 L165.7,137.5 L169.3,125.8 L169,108.8 L169.7,100.2 L165,95.5 L158.3,95.2 L145.7,97.8 L138.7,102.5 L130,108.2 L124.3,114.2 Z",
  //   E: "M168.3,94.5 L172,103.5 L175.3,107.5 L184,120.5 L190.3,127.5 L198.7,128.5 L203.3,124.8 L209.7,115.2 L219.7,92.5 L218.7,85.8 L209,83.8 L191.3,82.5 L182,84.2 L173.7,88.2 Z",
  //   F: "M222,87.5 L222.7,93.8 L226.7,98.2 L231,107.8 L236.7,121.5 L242,125.8 L248,126.8 L257,120.2 L275.3,101.5 L276,95.2 L273.7,92.2 L266,85.8 L248.7,80.5 L236.3,80.2 L229,81.8 Z",
  //   G: "M277.3,98.8 L276.7,107.2 L276,119.2 L276,129.5 L279.7,138.2 L285.7,141.2 L293.3,141.5 L301.7,135.8 L316.7,126.8 L320,122.5 L320,116.2 L316.3,109.8 L301.7,101.8 L294.7,98.8 L282,97.5 Z",
  //   H: "M305.7,136.5 L303,143.8 L301,150.5 L304,161.5 L313,170.2 L323,172.8 L331.7,172.5 L339.3,168.8 L346,162.5 L350.3,152.2 L351.3,141.2 L347.3,134.5 L343,132.2 L334,131.5 L322.3,130.2 L316,129.8 Z",
  //   I: "M359.3,167.2 L367.3,169.8 L375.3,182.5 L384,199.8 L389.7,211.8 L389.3,220.5 L386,227.5 L377.3,233.5 L363.3,238.5 L355.3,237.5 L348.3,233.2 L343.3,224.8 L337,211.5 L330.7,195.8 L328,186.8 L332.7,175.2 L342.7,168.5 Z",
  //   J: "M384.3,231.2 L391.3,232.5 L402.3,241.5 L409,253.8 L414.3,267.2 L416,281.8 L413.7,300.2 L409.3,308.8 L400.3,314.5 L386,317.2 L375,314.8 L367.3,310.5 L358.7,303.5 L353.7,291.5 L353.7,277.8 L354.7,267.8 L350.3,259.8 L351.7,248.2 L357.7,239.5 L367.7,237.5 Z",
  //   K: "M391.7,370.2 L379,367.8 L366.7,370.2 L356.3,378.8 L350.3,388.2 L347.7,396.2 L348,411.5 L346.7,427.8 L347.7,438.5 L352,445.2 L364.7,453.2 L374.3,455.5 L381.7,454.8 L389.7,451.8 L394.3,445.8 L397.7,433.8 L401.7,421.5 L406.7,413.5 L409.7,400.5 L408.7,390.5 L404.3,380.2 Z",
  //   L: "M354,450.2 L365.7,453.8 L377,459.5 L384.3,469.2 L385,481.5 L382.7,491.8 L369.7,517.8 L357.3,527.8 L340.7,532.2 L331.7,528.5 L324.3,523.5 L321,515.2 L320.7,504.2 L325.3,489.5 L330.3,470.2 L335,460.5 L343.7,453.2 Z",
  //   M: "M335,532.2 L341.7,546.5 L343.3,562.8 L339.7,570.5 L331.7,573.5 L309,572.5 L302,569.2 L298,564.5 L299.7,548.2 L303,539.5 L307.3,531.8 L315.3,525.2 L321.3,525.2 L325,525.5 Z",
  //   N: "M306.3,575.8 L298.7,569.2 L289.7,566.2 L280.7,564.2 L275.3,566.8 L272,572.2 L268.7,583.8 L267.3,593.2 L266.3,599.2 L266.7,603.8 L270.7,607.8 L276.3,608.8 L286.7,605.2 L300,597.5 L307.7,590.5 L309,583.5 Z",
  //   O: "M244.3,574.2 L235.7,575.2 L230.7,581.8 L225.7,593.5 L221.7,604.5 L220.3,609.8 L224,613.5 L234.3,615.5 L248.7,613.8 L258.7,610.8 L264,606.2 L265.3,598.8 Z",
  //   P: "M208,576.5 L218,607.2 L214,611.5 L206.7,613.2 L191,612.8 L179,606.8 L172.3,601.5 L174,597.8 L190.3,578.2 L199.7,571.8 L205.7,573.8 Z",
  //   Q: "M164.3,564.5 L168.3,568.8 L173,592.2 L172,598.2 L169.3,601.8 L162,601.8 L152,599.8 L142.3,595.5 L131,586.8 L130.7,584.5 L135,575.8 L140.3,570.2 L149.7,564.5 L159,562.8 Z",
  //   R: "M129.3,532.2 L137,535.2 L142.7,541.2 L146,548.8 L147.7,557.8 L144.7,565.2 L136.7,570.5 L123,573.8 L113,574.2 L105,572.8 L101.3,564.8 L103,551.2 L107.3,541.2 L111.3,535.5 L124,531.5 Z",
  //   S: "M93.7,456.2 L82.7,455.8 L70.7,460.8 L66.3,467.2 L63.7,474.2 L62,487.2 L63.3,500.2 L66.3,509.5 L70.3,517.2 L76.3,524.8 L85.3,531.2 L93.3,534.8 L102.3,535.8 L109.3,534.5 L119,529.8 L121.7,521.2 L122,510.2 L120.7,502.8 L114.3,484.5 L108.7,470.8 L103,462.5 Z",
  //   T: "M65.7,373.5 L74,375.2 L82,380.8 L86.3,384.8 L90.3,390.2 L92.7,395.8 L93,404.8 L93,416.8 L93,424.5 L94.3,432.2 L95.7,438.5 L94.7,444.2 L92.3,450.2 L89,453.5 L77.7,456.5 L68.7,460.5 L64.3,461.2 L54.7,456.5 L48.3,450.2 L42,442.2 L36.3,425.2 L33.3,407.8 L34.3,399.5 L36,392.8 L39.7,383.5 L47,377.2 L57,373.2 Z"

  //  adult: {
  //           // Q1 (Upper Right)
  //           '1-8': { x: 58, y: 324 },
  //           '1-7': { x: 61, y: 276 },
  //           '1-6': { x: 69, y: 234 },
  //           '1-5': { x: 85, y: 186 },
  //           '1-4': { x: 98, y: 140 },
  //           '1-3': { x: 127, y: 107 },
  //           '1-2': { x: 155, y: 86 },
  //           '1-1': { x: 195, y: 60 },

  //           // Q2 (Upper Left)
  //           '2-1': { x: 250, y: 55 },
  //           '2-2': { x: 292, y: 75 },
  //           '2-3': { x: 320, y: 107 },
  //           '2-4': { x: 338, y: 139 },
  //           '2-5': { x: 362, y: 176 },
  //           '2-6': { x: 375, y: 217 },
  //           '2-7': { x: 390, y: 267 },
  //           '2-8': { x: 398, y: 318 },

  //           // Q3 (Lower Left)
  //           '3-1': { x: 390, y: 390 },
  //           '3-2': { x: 387, y: 441 },
  //           '3-3': { x: 378, y: 497 },
  //           '3-4': { x: 362, y: 535 },
  //           '3-5': { x: 337, y: 593 },
  //           '3-6': { x: 306, y: 625 },
  //           '3-7': { x: 270, y: 641 },
  //           '3-8': { x: 237, y: 655 },

  //           // Q4 (Lower Right)
  //           '4-1': { x: 218, y: 660 },
  //           '4-2': { x: 174, y: 645 },
  //           '4-3': { x: 142, y: 628 },
  //           '4-4': { x: 119, y: 591 },
  //           '4-5': { x: 87, y: 551 },
  //           '4-6': { x: 73, y: 504 },
  //           '4-7': { x: 67, y: 450 },
  //           '4-8': { x: 53, y: 400 }
  //       },
  //       child: {
  //           A: { x: 60, y: 279 },
  //           B: { x: 77, y: 209 },
  //           C: { x: 119, y: 151 },
  //           D: { x: 151, y: 119 },
  //           E: { x: 210, y: 87 },
  //           F: { x: 240, y: 90 },
  //           G: { x: 290, y: 109 },
  //           H: { x: 340, y: 151 },
  //           I: { x: 380, y: 202 },
  //           J: { x: 397, y: 272 },
  //           K: { x: 388, y: 411 },
  //           L: { x: 369, y: 491 },
  //           M: { x: 335, y: 545 },
  //           N: { x: 289, y: 582 },
  //           O: { x: 240, y: 614 },
  //           P: { x: 190, y: 614 },
  //           Q: { x: 152, y: 583 },
  //           R: { x: 125, y: 552 },
  //           S: { x: 93, y: 496 },
  //           T: { x: 53, y: 415 }
  //       }

import React, { useState, useRef, useEffect } from 'react';
import { Calendar, User, Activity, AlertCircle, Loader2 } from 'lucide-react';
import { useLocation } from 'react-router-dom';

const ISSUE_COLORS = {
  cavity: '#000000',      // black
  gumDisease: '#FF0A0A',  // red
  missing: '#4264D0',     // blue
  filling: '#9CA3AF',     // gray
  rootCanal: '#FB9F63',   // orange
  other: '#0EE9E2',       // cyan
  healthy: '#FFFFFF'      // white (default)
};

// API service for fetching dental chart data
const dentalChartAPI = {
  async fetchDentalChart(patientId) {
    try {
      const response = await fetch(`${import.meta.env.VITE_BACKEND_URL}/api/dentalchart/${patientId}`);
      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.message || 'Failed to fetch dental chart');
      }

      return data.data;
    } catch (error) {
      console.error('Error fetching dental chart:', error);
      throw error;
    }
  }
};

// Enhanced Dental SVG Chart Component with full responsive design
const DentalSVGChart = ({
  isAdult,
  toothIssues = {},
  showLabels = true,
  readOnly = true
}) => {
  // Adult tooth positions - you'll need to populate these with your actual tooth paths
  const toothShapes = {
    
//  // Q1 (Upper Right) - 11, 12, 13, 14, 15, 16, 17, 18
   '1-8': "M33,314.3 L38,325.7 L45.7,335.7 L55.7,341.7 L64.7,343 L73.3,340 L77.7,335.7 L81.3,326.3 L82,314.3 L81.3,302 L80.7,292.7 L73.7,292 L51.3,293.7 L38.7,293.7 L34,298 L31.7,302.3 L32,311 Z",
    '1-7': "M79.7,288.3 L71.7,291 L55,293 L40.3,291.3 L36,287 L33,273.7 L36.3,260 L42,248.7 L44.7,244.7 L50.3,246.7 L56,249 L65.3,250.7 L74,249.7 L80.3,249.7 L82.3,254 L85.3,259.3 L87,267.7 L87.7,274.7 L85.3,282.7 Z",
    '1-6': "M92.7,207.3 L94.7,212.6 L93,220.6 L91.3,229.6 L87.3,237.6 L82.3,245.3 L71.3,250 L57.6,250.7 L47.6,243.7 L45.9,238.7 L45,220 L48,209.3 L53,202 L57,198.7 L61.7,196 L67,199.7 L73.7,201 L81,201 L87.3,201.7 L92.7,203.7 Z",
    '1-5': "M82,155.3 L102.3,163.3 L108.7,172 L109.3,182 L104.7,192 L100,199 L94,203.7 L85.3,201.7 L73.7,201 L64.3,196.7 L60.3,190.7 L59,183.3 L61.7,175.3 L66.3,167.7 L71.3,161.3 Z",
    '1-4': "M109,116.7 L116,122.3 L122.7,125.3 L127.7,131.3 L128.3,141 L122.7,153.7 L114,161.7 L105.7,162.3 L96.7,161 L85.7,156 L82,150 L81,139.3 L86.3,128 L93,121.3 L100.7,117.3 Z",
    '1-3': "M126.3,82 L134.3,86.3 L139.7,92.3 L144.7,104.7 L145.7,115.3 L143.7,120.7 L138,124.3 L131.3,125 L121,125 L114.7,119.3 L110.3,112.3 L108.3,104.7 L108.7,94.7 L110.7,88.7 L116,84 Z",
    '1-2': "M167,55 L173.7,61.3 L174,68 L174.3,76 L175.3,86 L173.3,94.3 L168.6,98.6 L161.9,100.3 L153.9,96 L146.6,91.3 L137.3,86.6 L131,81.3 L130,77 L131.3,72 L135.6,66 L141.9,60 L152.2,55.3 L162.5,55 Z",
    '1-1': "M176.7,46.3 L195,41 L203.3,39.7 L209.3,40.7 L215.3,42.7 L217,47 L217.7,54.3 L215,64.7 L212.3,75.7 L208,83 L201.7,85.7 L195.7,86.7 L189.7,83.3 L183.7,74.7 L175,62 L171.7,54 L172.7,49.7 Z",

    // Q2 (Upper Left) - 21, 22, 23, 24, 25, 26, 27, 28
    '2-1': "M273.3,52 L266.7,61.7 L258.3,72.3 L253.3,79.7 L247.3,85 L239,87.7 L232.3,82 L224.7,67 L222,58.3 L219,50 L220,44.3 L224.3,40.3 L230,38.7 L237.3,38.7 L253,39.3 L258.7,41.3 L264.3,43.7 L268.3,45.7 Z",
    '2-2': "M310.3,83.3 L298,90.7 L286,95 L276.3,98.3 L270.3,93.3 L269,82.7 L269,69.3 L270,58.7 L274.7,54.7 L282,53 L287.7,54.7 L297.3,60.3 L304,64.3 L308.7,68.7 L312.3,74 L313,81 Z",
    '2-3': "M336,93.3 L337.7,100 L336,104.7 L332.7,113.7 L324.3,121.3 L315.3,125.7 L306.3,126 L297.3,120.3 L294,112 L295.7,102.7 L299,95 L303.3,90 L309.3,88 L316.3,87.3 L322.7,87.3 L328,88.3 Z",
    '2-4': "M358.7,134.3 L360.3,145.7 L357.3,152.7 L352,157.3 L346.3,161 L336,164 L329.7,163.3 L321.7,157.7 L314.3,149 L310.7,139.3 L310,133.7 L312.3,127 L318.3,125.7 L326,122 L332.7,116 L334.7,114.3 L337.7,117.3 L343.3,119.7 L348.7,122.7 L354.3,127.7 Z",
    '2-5': "M386,188.7 L383.3,192.7 L377.7,196 L356.3,203.3 L345.7,202.3 L341.7,199.7 L338.7,196.3 L335,188.7 L332,177 L333.7,169.7 L338,164.7 L346.3,161 L353.7,156.7 L360.3,150.3 L364,151 L370.7,156.3 L376.3,164.3 L380,170.3 L383.3,178.3 Z",
    '2-6': "M359.7,243.7 L350.7,224 L345.7,211.7 L348.7,205 L358.3,202.7 L375.7,197 L388.7,193 L393,196 L399.3,207 L401.3,222.7 L400,234.3 L394.7,240.7 L381.7,244.7 L371,246 Z",
    '2-7': "M362.3,247.3 L357.3,251 L357,259.3 L358.7,268 L359.7,279.7 L361.3,286.7 L365,291.7 L371,294.3 L392,295 L404.3,293.7 L410,280.7 L412,263.3 L407.3,246.7 L401,240.3 L396,239.7 L389.3,243 Z",
    '2-8': "M404.3,293.7 L408.7,299.3 L408.7,308 L405.3,318.7 L401,329.7 L392.3,339.7 L382.7,341 L369,339.7 L359,335 L354.7,327.7 L354.3,316 L358.3,304 L363.7,294 L368.7,294.7 L378.7,296 L389,296 Z",

    // Q3 (Lower Left) - 31, 32, 33, 34, 35, 36, 37, 38
    '3-1': "M371.7,417 L378.3,417.3 L386.7,415.7 L391.7,415.3 L397.3,417.7 L402.7,416.3 L407.7,409.7 L406.7,395 L401,377.7 L397.3,373 L390.7,367.3 L380,365 L373,366.7 L367.3,369 L364,374.3 L360,389 L363.3,401.3 L367.7,412.3 Z",
    '3-2': "M410,435 L408.7,447.3 L404.3,459 L399.3,467.7 L393.7,468 L388,466 L376.3,466.3 L369.7,466.3 L365.7,460 L364.7,444.7 L366.3,434.3 L369,424 L378.3,417.3 L386.7,415.7 L391.7,415.3 L396,418 L399.7,418 L404,421.7 L407.7,427.3 Z",
    '3-3': "M398,470 L402.7,475.7 L405.7,483.4 L405.4,495.1 L399.4,508.4 L393.1,518.7 L384.8,523 L377.5,522 L361.2,515 L358.2,508 L357.9,497 L361.6,482.7 L365.3,475.7 L370.6,469 L378.6,467 L388.3,467.3 Z",
    '3-4': "M334,561 L338.7,566 L346,570 L354.7,573 L360.7,571.7 L368,568.3 L383,545 L385.3,532.7 L381.3,524.3 L374,520.7 L363.7,516.3 L356.3,515.3 L351.3,518.3 L346.3,524 L340.3,534.3 L336,546.7 Z",
    '3-5': "M331,565.7 L335,565.7 L341.3,568 L349.3,574.3 L352.3,578.3 L352.7,583.7 L350.7,593.7 L342.7,604 L337.7,609 L328,612.7 L320,613.3 L315,611 L308.3,604.7 L306.7,598 L307.3,591.3 L309,584.7 L312.7,578.3 L318.3,571.7 Z",
    '3-6': "M286,629.3 L286.7,633.3 L291.3,638.7 L295.3,642.3 L302,644 L311.7,643.3 L318.3,637.7 L321,630 L321.3,620.3 L317,614.3 L308,608 L298.3,607 L291,609.3 L287,612.3 L286.7,617.7 L287.3,624.7 Z",
    '3-7': "M269.3,624 L273.3,624.7 L275.3,627.3 L279,628.7 L281.7,631.3 L285.3,634.7 L289.3,638.3 L292,643.3 L291.3,650 L287,655 L280.7,658.7 L272,660 L265,660.7 L261.3,657.3 L261.7,650 L263.7,637 L264.3,627 Z",
    '3-8': "M235.3,637 L239.3,634.7 L243.3,634.7 L248.6,639 L253.9,646.3 L257.2,653.6 L257.2,660.3 L249.5,663 L239.5,663.3 L229.5,663.3 L227.5,656.6 L230.2,649.3 Z",

    '4-1': "M214,637 L218,642.7 L223,654.3 L225.7,664 L225.3,666.3 L219,668.3 L206.7,668 L196,665.7 L190.3,662.7 L193,657.3 L199.7,647.3 L207,638 L210.7,635.5 Z",
    '4-2': "M178.3,627 L186,629 L187.7,633.7 L188.7,644 L189,657 L189.3,662.7 L186.3,663.7 L176.7,663 L168,656.3 L159.3,649.7 L156.7,644 L162,639.3 Z",
    '4-3': "M155.7,611 L160.3,615.3 L165,624.7 L161.7,634.3 L156,641.3 L149,644 L140.7,644.3 L133.3,641.3 L128.7,634.7 L128.7,629 L132.7,621.3 L137.7,615 L143.7,611 L149.7,610 Z",
    '4-4': "M117.3,569.7 L125,571 L131.3,574.7 L137.6,582.4 L141.6,590.7 L143.3,602 L142,608.7 L135.3,615.4 L127.6,618.7 L120.3,617.7 L113.3,614.7 L106,607.7 L101,598.7 L99,588.7 L99.3,581.4 L100.6,574.7 L106,568 L112.3,563 Z",
    '4-5': "M93.3,525 L99.3,527.3 L108.3,536 L114,546.7 L115.7,559.3 L114.3,567.3 L106.3,573 L98.3,578.3 L88,579 L82,575 L75,565 L69.3,552.3 L67.3,542 L69.7,536 L74.3,531.7 L84.3,528.3 Z",
    '4-6': "M78.7,476 L85,481 L90.3,488.3 L96.3,499.3 L97.7,511.3 L93,522 L86,526.3 L67,533 L60.3,529.7 L56.3,523.7 L51.7,511 L47.7,494.7 L47.7,488.3 L50.3,483.3 L55,479.7 L67,476.7 Z",
    '4-7': "M76,425.7 L80.3,427.7 L83.3,433 L85.3,447.7 L84.3,458.7 L79.7,472.3 L73,475 L50.3,479.7 L46.7,476.7 L37.7,446.3 L39.7,438.3 L43.3,432 L49,426.7 L56,424.7 L65,424.7 Z",
    '4-8': "M66.7,369.7 L59,370.3 L51,373.7 L43.7,384.3 L42.3,392 L38.7,406 L41,415.3 L44.3,420.3 L47.3,424 L51.7,424.3 L57.7,424 L62.3,422.7 L66.7,422.7 L71,424.3 L76.3,422.7 L80.7,419.3 L84.7,412.3 L85.3,405 L87.3,391.7 L85,380 L80.7,375 L73.7,371.3 Z"

  };

  // Child tooth shapes - you'll need to populate these with your actual tooth paths
  const childToothShapes = {
   
  A: "M55.2,236.1 L60,237.2 L69.8,240.2 L86.9,243.3 L92,247 L95.7,255.8 L95.7,271.2 L94.7,286.5 L90.2,305.2 L82.8,312.8 L72,318.5 L56.7,319.3 L48.8,317.5 L40.8,311.5 L33,300.3 L31.3,284.7 L34.2,273.8 L39.3,256.3 L42.3,248 Z",
    B: "M90.2,242.2 L97.3,236.1 L106.3,224.2 L114.9,200.1 L117.3,189.4 L113,179.1 L95.7,169.8 L86.2,169.8 L71.9,179.1 L63.5,191.3 L58.6,202.5 L54,215.2 L55.8,227.2 L65.8,238.9 L79.1,242.2 Z",
    C: "M106.7,132.2 L118,132.2 L130.3,132.5 L139.7,138.2 L144.7,147.8 L144.7,160.8 L134.3,173.8 L121.7,180.2 L115,180.2 L107.7,174.5 L100,169.8 L98.7,156.8 L97.3,147.8 L98.3,138.8 L104.7,133.2 Z",
    D: "M123.7,124.2 L131.3,131.2 L143.3,137.5 L151.3,141.8 L159,142.5 L165.7,137.5 L169.3,125.8 L169,108.8 L169.7,100.2 L165,95.5 L158.3,95.2 L145.7,97.8 L138.7,102.5 L130,108.2 L124.3,114.2 Z",
    E: "M168.3,94.5 L172,103.5 L175.3,107.5 L184,120.5 L190.3,127.5 L198.7,128.5 L203.3,124.8 L209.7,115.2 L219.7,92.5 L218.7,85.8 L209,83.8 L191.3,82.5 L182,84.2 L173.7,88.2 Z",
    F: "M222,87.5 L222.7,93.8 L226.7,98.2 L231,107.8 L236.7,121.5 L242,125.8 L248,126.8 L257,120.2 L275.3,101.5 L276,95.2 L273.7,92.2 L266,85.8 L248.7,80.5 L236.3,80.2 L229,81.8 Z",
    G: "M277.3,98.8 L276.7,107.2 L276,119.2 L276,129.5 L279.7,138.2 L285.7,141.2 L293.3,141.5 L301.7,135.8 L316.7,126.8 L320,122.5 L320,116.2 L316.3,109.8 L301.7,101.8 L294.7,98.8 L282,97.5 Z",
    H: "M305.7,136.5 L303,143.8 L301,150.5 L304,161.5 L313,170.2 L323,172.8 L331.7,172.5 L339.3,168.8 L346,162.5 L350.3,152.2 L351.3,141.2 L347.3,134.5 L343,132.2 L334,131.5 L322.3,130.2 L316,129.8 Z",
    I: "M359.3,167.2 L367.3,169.8 L375.3,182.5 L384,199.8 L389.7,211.8 L389.3,220.5 L386,227.5 L377.3,233.5 L363.3,238.5 L355.3,237.5 L348.3,233.2 L343.3,224.8 L337,211.5 L330.7,195.8 L328,186.8 L332.7,175.2 L342.7,168.5 Z",
    J: "M384.3,231.2 L391.3,232.5 L402.3,241.5 L409,253.8 L414.3,267.2 L416,281.8 L413.7,300.2 L409.3,308.8 L400.3,314.5 L386,317.2 L375,314.8 L367.3,310.5 L358.7,303.5 L353.7,291.5 L353.7,277.8 L354.7,267.8 L350.3,259.8 L351.7,248.2 L357.7,239.5 L367.7,237.5 Z",
    K: "M391.7,370.2 L379,367.8 L366.7,370.2 L356.3,378.8 L350.3,388.2 L347.7,396.2 L348,411.5 L346.7,427.8 L347.7,438.5 L352,445.2 L364.7,453.2 L374.3,455.5 L381.7,454.8 L389.7,451.8 L394.3,445.8 L397.7,433.8 L401.7,421.5 L406.7,413.5 L409.7,400.5 L408.7,390.5 L404.3,380.2 Z",
    L: "M354,450.2 L365.7,453.8 L377,459.5 L384.3,469.2 L385,481.5 L382.7,491.8 L369.7,517.8 L357.3,527.8 L340.7,532.2 L331.7,528.5 L324.3,523.5 L321,515.2 L320.7,504.2 L325.3,489.5 L330.3,470.2 L335,460.5 L343.7,453.2 Z",
    M: "M335,532.2 L341.7,546.5 L343.3,562.8 L339.7,570.5 L331.7,573.5 L309,572.5 L302,569.2 L298,564.5 L299.7,548.2 L303,539.5 L307.3,531.8 L315.3,525.2 L321.3,525.2 L325,525.5 Z",
    N: "M306.3,575.8 L298.7,569.2 L289.7,566.2 L280.7,564.2 L275.3,566.8 L272,572.2 L268.7,583.8 L267.3,593.2 L266.3,599.2 L266.7,603.8 L270.7,607.8 L276.3,608.8 L286.7,605.2 L300,597.5 L307.7,590.5 L309,583.5 Z",
    O: "M244.3,574.2 L235.7,575.2 L230.7,581.8 L225.7,593.5 L221.7,604.5 L220.3,609.8 L224,613.5 L234.3,615.5 L248.7,613.8 L258.7,610.8 L264,606.2 L265.3,598.8 Z",
    P: "M208,576.5 L218,607.2 L214,611.5 L206.7,613.2 L191,612.8 L179,606.8 L172.3,601.5 L174,597.8 L190.3,578.2 L199.7,571.8 L205.7,573.8 Z",
    Q: "M164.3,564.5 L168.3,568.8 L173,592.2 L172,598.2 L169.3,601.8 L162,601.8 L152,599.8 L142.3,595.5 L131,586.8 L130.7,584.5 L135,575.8 L140.3,570.2 L149.7,564.5 L159,562.8 Z",
    R: "M129.3,532.2 L137,535.2 L142.7,541.2 L146,548.8 L147.7,557.8 L144.7,565.2 L136.7,570.5 L123,573.8 L113,574.2 L105,572.8 L101.3,564.8 L103,551.2 L107.3,541.2 L111.3,535.5 L124,531.5 Z",
    S: "M93.7,456.2 L82.7,455.8 L70.7,460.8 L66.3,467.2 L63.7,474.2 L62,487.2 L63.3,500.2 L66.3,509.5 L70.3,517.2 L76.3,524.8 L85.3,531.2 L93.3,534.8 L102.3,535.8 L109.3,534.5 L119,529.8 L121.7,521.2 L122,510.2 L120.7,502.8 L114.3,484.5 L108.7,470.8 L103,462.5 Z",
    T: "M65.7,373.5 L74,375.2 L82,380.8 L86.3,384.8 L90.3,390.2 L92.7,395.8 L93,404.8 L93,416.8 L93,424.5 L94.3,432.2 L95.7,438.5 L94.7,444.2 L92.3,450.2 L89,453.5 L77.7,456.5 L68.7,460.5 L64.3,461.2 L54.7,456.5 L48.3,450.2 L42,442.2 L36.3,425.2 L33.3,407.8 L34.3,399.5 L36,392.8 L39.7,383.5 L47,377.2 L57,373.2 Z"


  };

  const toothLabels = {
      adult: {
            // Q1 (Upper Right)
            '1-8': { x: 58, y: 324 },
            '1-7': { x: 61, y: 276 },
            '1-6': { x: 69, y: 234 },
            '1-5': { x: 85, y: 186 },
            '1-4': { x: 98, y: 140 },
            '1-3': { x: 127, y: 107 },
            '1-2': { x: 155, y: 86 },
            '1-1': { x: 195, y: 60 },

            // Q2 (Upper Left)
            '2-1': { x: 250, y: 55 },
            '2-2': { x: 292, y: 75 },
            '2-3': { x: 320, y: 107 },
            '2-4': { x: 338, y: 139 },
            '2-5': { x: 362, y: 176 },
            '2-6': { x: 375, y: 217 },
            '2-7': { x: 390, y: 267 },
            '2-8': { x: 398, y: 318 },

            // Q3 (Lower Left)
            '3-1': { x: 390, y: 390 },
            '3-2': { x: 387, y: 441 },
            '3-3': { x: 378, y: 497 },
            '3-4': { x: 362, y: 535 },
            '3-5': { x: 337, y: 593 },
            '3-6': { x: 306, y: 625 },
            '3-7': { x: 270, y: 641 },
            '3-8': { x: 237, y: 655 },

            // Q4 (Lower Right)
            '4-1': { x: 218, y: 660 },
            '4-2': { x: 174, y: 645 },
            '4-3': { x: 142, y: 628 },
            '4-4': { x: 119, y: 591 },
            '4-5': { x: 87, y: 551 },
            '4-6': { x: 73, y: 504 },
            '4-7': { x: 67, y: 450 },
            '4-8': { x: 53, y: 400 }
        },
        child: {
            A: { x: 60, y: 279 },
            B: { x: 77, y: 209 },
            C: { x: 119, y: 151 },
            D: { x: 151, y: 119 },
            E: { x: 210, y: 87 },
            F: { x: 240, y: 90 },
            G: { x: 290, y: 109 },
            H: { x: 340, y: 151 },
            I: { x: 380, y: 202 },
            J: { x: 397, y: 272 },
            K: { x: 388, y: 411 },
            L: { x: 369, y: 491 },
            M: { x: 335, y: 545 },
            N: { x: 289, y: 582 },
            O: { x: 240, y: 614 },
            P: { x: 190, y: 614 },
            Q: { x: 152, y: 583 },
            R: { x: 125, y: 552 },
            S: { x: 93, y: 496 },
            T: { x: 53, y: 415 }
        }
  };

  const currentTeeth = isAdult ? Object.keys(toothLabels.adult || {}) : Object.keys(toothLabels.child || {});
  const currentLabels = isAdult ? toothLabels.adult : toothLabels.child;
  const currentShapes = isAdult ? toothShapes : childToothShapes;

  // Function to get tooth color based on issues
  const getToothColor = (toothId) => {
    const issues = toothIssues[toothId];
    if (!issues || !Array.isArray(issues) || issues.length === 0) {
      return ISSUE_COLORS.healthy;
    }
    return ISSUE_COLORS[issues[0]] || ISSUE_COLORS.healthy;
  };

  // Function to check if tooth has issues
  const hasIssues = (toothId) => {
    const issues = toothIssues[toothId];
    return issues && Array.isArray(issues) && issues.length > 0;
  };

  return (
    <div className="w-full flex justify-center">
      <div className="relative bg-white w-full max-w-xl">
        <svg
          viewBox="0 0 450 800"
          className="w-full max-h-[700px] p-2"
          style={{ filter: 'drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1))' }}
        >
          <defs>
            <radialGradient id="healthy-gradient" cx="0.3" cy="0.3">
              <stop offset="0%" stopColor="#FFFFFF" />
              <stop offset="70%" stopColor="#F9FAFB" />
              <stop offset="100%" stopColor="#FFFFFF" />
            </radialGradient>
          </defs>

          {/* Chart Labels */}
          <text x="225" y="15" textAnchor="middle" className="text-sm font-bold fill-gray-700">Upper Jaw</text>
          <text x="225" y="580" textAnchor="middle" className="text-sm font-bold fill-gray-700">Lower Jaw</text>
          <text x="415" y="300" textAnchor="middle" className="text-sm font-bold fill-gray-700">Right</text>
          <text x="35" y="300" textAnchor="middle" className="text-sm font-bold fill-gray-700">Left</text>

          {/* Quadrant Labels */}
          {isAdult && (
            <>
              <text x="165" y="180" textAnchor="middle" className="text-xs font-medium fill-gray-600">Q1 (Upper Right)</text>
              <text x="290" y="180" textAnchor="middle" className="text-xs font-medium fill-gray-600">Q2 (Upper Left)</text>
              <text x="290" y="380" textAnchor="middle" className="text-xs font-medium fill-gray-600">Q3 (Lower Left)</text>
              <text x="160" y="380" textAnchor="middle" className="text-xs font-medium fill-gray-600">Q4 (Lower Right)</text>
            </>
          )}

          {/* Guide Lines */}
          <g stroke="#10B981" strokeWidth="1" opacity="0.4">
            <line x1="225" y1="30" x2="225" y2="280" strokeDasharray="3,3" />
            <line x1="225" y1="280" x2="225" y2="530" strokeDasharray="3,3" />
            <line x1="60" y1="280" x2="390" y2="280" strokeDasharray="3,3" />
          </g>

          {/* External tooth numbering and issue indicators */}
          {showLabels && currentTeeth.map((toothId) => {
            const labelPos = currentLabels[toothId];
            const hasToothIssues = hasIssues(toothId);

            if (!labelPos) return null;

            let externalX, externalY;
            const centerX = 225, centerY = 300;
            const isUpper = labelPos.y < centerY;
            const isLeft = labelPos.x > centerX;

            if (isUpper && !isLeft) {
              externalX = labelPos.x - 35;
              externalY = labelPos.y - 25;
            } else if (isUpper && isLeft) {
              externalX = labelPos.x + 35;
              externalY = labelPos.y - 25;
            } else if (!isUpper && isLeft) {
              externalX = labelPos.x + 35;
              externalY = labelPos.y + 25;
            } else {
              externalX = labelPos.x - 35;
              externalY = labelPos.y + 25;
            }

            return (
              <g key={`label-${toothId}`}>
                <line
                  x1={labelPos.x}
                  y1={labelPos.y}
                  x2={externalX}
                  y2={externalY}
                  stroke={hasToothIssues ? "#DC2626" : "#6B7280"}
                  strokeWidth={hasToothIssues ? "1.5" : "1"}
                  strokeDasharray="2,2"
                  opacity="0.6"
                  className="pointer-events-none"
                />
                <circle
                  cx={externalX}
                  cy={externalY}
                  r="10"
                  fill={hasToothIssues ? "#DC2626" : "#F3F4F6"}
                  strokeWidth="3"
                  className="pointer-events-none"
                />
                <text
                  x={externalX}
                  y={externalY + 3}
                  textAnchor="middle"
                  className={`text-xs font-bold pointer-events-none select-none ${hasToothIssues ? 'fill-white' : 'fill-gray-700'}`}
                >
                  {toothId}
                </text>
              </g>
            );
          })}

          {/* Tooth rendering with automatic coloring */}
          {currentTeeth.map((toothId) => {
            const toothPath = currentShapes[toothId];
            const hasToothIssues = hasIssues(toothId);
            const toothColor = getToothColor(toothId);

            if (!toothPath) return null;

            return (
              <g key={toothId} className="tooth-element">
                <path
                  d={toothPath}
                  fill={toothColor}
                  stroke={hasToothIssues ? "#374151" : "#9CA3AF"}
                  strokeWidth={hasToothIssues ? "2" : "1.5"}
                  className="transition-all duration-300"
                  style={{
                    filter: "drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1))",
                    transform: hasToothIssues ? "scale(1.01)" : "scale(1)",
                    transformOrigin: "center",
                  }}
                />
              </g>
            );
          })}
        </svg>
      </div>
    </div>
  );
};

// Optimized Dental Chart Viewer Component
const DentalChartViewer = ({ patientId, printTrigger }) => {
  const [chartData, setChartData] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  // Function to fetch chart data
  const fetchChartData = async () => {
    if (!patientId) {
      setError('Patient ID is required');
      return;
    }

    try {
      setLoading(true);
      setError(null);

      const data = await dentalChartAPI.fetchDentalChart(patientId);
      setChartData(data);
    } catch (err) {
      console.error('Error fetching dental chart:', err);
      setError(err.message || 'Failed to load dental chart');
    } finally {
      setLoading(false);
    }
  };

  // Handle print trigger to refresh data
  useEffect(() => {
    if (printTrigger > 0) {
      console.log('Print triggered, refreshing dental chart data...');
      fetchChartData();
    }
  }, [printTrigger]);

  // Initial data fetch
  useEffect(() => {
    fetchChartData();
  }, [patientId]);

  if (loading) {
    return (
      <div className="flex justify-center items-center h-32 w-full">
        <div className="flex items-center space-x-2">
          <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
          <span className="text-gray-600 text-sm">Loading chart...</span>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="flex justify-center items-center h-32 w-full">
        <div className="text-center">
          <div className="text-red-500 text-sm font-semibold mb-2">Error Loading Chart</div>
          <div className="text-gray-600 text-xs mb-3">{error}</div>
          <button
            onClick={() => fetchChartData()}
            className="px-4 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
          >
            Retry
          </button>
        </div>
      </div>
    );
  }

  if (!chartData) {
    return (
      <div className="flex justify-center items-center h-32 w-full">
        <div className="text-gray-600 text-sm">No dental chart data available</div>
      </div>
    );
  }

  return (
    <div className="w-full">
      {/* Chart Header - Compact */}
      <div className="mb-4 text-center">
        <h2 className="text-lg font-bold text-gray-800 mb-1">
          {chartData.isAdult ? 'Adult' : 'Child'} Dental Chart
        </h2>
        <div className="text-xs text-gray-600">
          Last Updated: {new Date(chartData.updatedAt).toLocaleDateString()}
        </div>
      </div>

      {/* Legend - Compact */}
      <div className="mb-4">
        <h3 className="text-sm font-semibold mb-2">Issue Types</h3>
        <div className="grid grid-cols-4 gap-2 text-xs">
          {Object.entries(ISSUE_COLORS).map(([issue, color]) => {
            if (issue === 'healthy') return null;
            return (
              <div key={issue} className="flex items-center space-x-1">
                <div
                  className="w-3 h-3 rounded border border-gray-300"
                  style={{ backgroundColor: color }}
                ></div>
                <span className="capitalize">{issue.replace(/([A-Z])/g, ' $1')}</span>
              </div>
            );
          })}
        </div>
      </div>

      {/* Dental Chart */}
      <DentalSVGChart
        isAdult={chartData.isAdult}
        toothIssues={chartData.toothIssues || {}}
        showLabels={true}
        readOnly={true}
      />

      {/* Detailed Issues List - Compact */}
      {Object.keys(chartData.toothIssues || {}).length > 0 && (
        <div className="p-3 bg-white rounded-lg shadow-sm">
          <h3 className="text-sm font-semibold mb-3">Detailed Issues</h3>
          <div className="space-y-2">
            {Object.entries(chartData.toothIssues || {}).map(([toothId, issues]) => (
              <div key={toothId} className="flex flex-col sm:flex-row sm:items-center sm:justify-between p-2 bg-gray-50 rounded">
                <div className="font-medium text-gray-800 text-sm mb-1 sm:mb-0">Tooth {toothId}:</div>
                <div className="flex flex-wrap gap-1">
                  {issues.map((issue, index) => (
                    <span
                      key={index}
                      className="px-2 py-1 text-xs rounded-full text-white font-medium"
                      style={{ backgroundColor: ISSUE_COLORS[issue] || '#6B7280' }}
                    >
                      {issue}
                    </span>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

// Optimized Medical Report PDF Component
const MedicalReportPDF = ({ printTrigger, medications, suggestions, hospitalId, patientId, patient, state }) => {
  const location = useLocation();
  const patientInfo = patient || location.state?.patient || {};

  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  // Dynamic data states
  const [patientData, setPatientData] = useState({});
  const [proformaData, setProformaData] = useState({});
  const [treatments, setTreatments] = useState([]);
  const [dentalChart, setDentalChart] = useState(null);
  
  // Add state for dynamic clinic/hospital data
  const [hospitalData, setHospitalData] = useState({
    name: '',
    address: '',
    phone: '',
    email: ''
  });

  // Message state for notifications
  const [message, setMessage] = useState({ text: '', type: '' });

  // API configuration
  const API_BASE_URL = `${import.meta.env.VITE_BACKEND_URL}`;
  
  const getAuthToken = () => {
    return localStorage.getItem('token') || sessionStorage.getItem('token');
  };

  const apiCall = async (endpoint, options = {}) => {
    const token = getAuthToken();
    const defaultHeaders = {
      'Content-Type': 'application/json',
      ...(token && { 'Authorization': `Bearer ${token}` })
    };

    const response = await fetch(`${API_BASE_URL}/api${endpoint}`, {
      ...options,
      headers: {
        ...defaultHeaders,
        ...options.headers
      }
    });

    if (!response.ok) {
      throw new Error(`API call failed: ${response.statusText}`);
    }

    return response.json();
  };

  // Helper functions for data retrieval with priority checking
  const getPatientMedicalHistory = () => {
    return patientData.medicalHistory ||
           proformaData.medicalHistory ||
           patientInfo.medicalHistory ||
           'No significant medical history available';
  };

  const getPatientPhoneNumber = () => {
    return patientData.phone ||
           patientData.primaryNumber ||
           patientData.contactNumber ||
           patientData.phoneNumber ||
           patientInfo.phone ||
           patientInfo.primaryNumber ||
           patientInfo.contactNumber ||
           patientInfo.phoneNumber ||
           'N/A';
  };

  // Enhanced patient validation
  const validatePatientData = (patient) => {
    const hasValidId = patient && (
      patient._id ||
      patient.id ||
      patient.patientId
    );
    return hasValidId;
  };

  // Show message with auto-hide
  const showMessage = (text, type = 'success') => {
    setMessage({ text, type });
    setTimeout(() => setMessage({ text: '', type: '' }), 5000);
  };

  // Load hospital/clinic data
  const loadHospitalData = async () => {
    try {
      console.log('Loading hospital data...');
      
      const profileData = await apiCall('/auth/profile');
      const userData = profileData.admin || profileData.receptionist || profileData.user || profileData;
      const hospital = profileData.hospital;
      
      let hospitalInfo = {
        name: '',
        address: '',
        phone: '',
        email: ''
      };

      if (hospital) {
        hospitalInfo = {
          name: hospital.name || hospitalInfo.name,
          address: hospital.address || hospital.location || '',
          phone: hospital.phone || hospital.contactNumber || '',
          email: hospital.email || ''
        };
      } else if (userData && userData.hospitalId) {
        try {
          const hospitalResponse = await apiCall(`/hospitals/${userData.hospitalId}`);
          const hospitalData = hospitalResponse.data || hospitalResponse;
          if (hospitalData) {
            hospitalInfo = {
              name: hospitalData.name || hospitalInfo.name,
              address: hospitalData.address || hospitalData.location || '',
              phone: hospitalData.phone || hospitalData.contactNumber || '',
              email: hospitalData.email || ''
            };
          }
        } catch (hospitalError) {
          console.log('Could not fetch hospital data directly:', hospitalError);
        }
      }

      if (userData) {
        hospitalInfo = {
          ...hospitalInfo,
          address: hospitalInfo.address || userData.location || '',
          phone: hospitalInfo.phone || userData.phone || userData.primaryNumber || '',
          email: hospitalInfo.email || userData.email || ''
        };
      }

      setHospitalData(hospitalInfo);
      
    } catch (error) {
      console.error('Error loading hospital data:', error);
      setHospitalData({
        name: '',
        address: '',
        phone: '',
        email: ''
      });
    }
  };

  // Optimized data fetching - fetch all at once
  const fetchAllReportData = async () => {
    if (!validatePatientData(patientInfo)) {
      setError('Invalid patient data');
      return;
    }

    setLoading(true);
    setError('');

    try {
      console.log('Starting to fetch all report data...');
      
      // Run all API calls in parallel for faster loading
      const [
        hospitalResult,
        patientResult,
        proformaResult,
        treatmentResult,
        dentalChartResult
      ] = await Promise.allSettled([
        loadHospitalData(),
        fetchPatientData(),
        fetchProformaData(),
        fetchTreatmentData(),
        fetchDentalChartData()
      ]);

      // Log any failures but don't stop the whole process
      [hospitalResult, patientResult, proformaResult, treatmentResult, dentalChartResult].forEach((result, index) => {
        if (result.status === 'rejected') {
          const names = ['Hospital', 'Patient', 'Proforma', 'Treatment', 'Dental Chart'];
          console.warn(`${names[index]} data failed to load:`, result.reason);
        }
      });

      console.log('Report data fetching completed');
    } catch (err) {
      console.error('Critical error fetching report data:', err);
      setError('Failed to load report data. Please try refreshing the page.');
      showMessage('Failed to load report data', 'error');
    } finally {
      setLoading(false);
    }
  };

  const fetchDentalChartData = async () => {
    try {
      const currentPatientId = patientInfo._id || patientInfo.id || patientInfo.patientId;

      if (!currentPatientId) {
        console.log('No patient ID for dental chart data');
        setDentalChart(null);
        return;
      }

      const data = await dentalChartAPI.fetchDentalChart(currentPatientId);
      setDentalChart(data);
    } catch (error) {
      console.error('Error fetching dental chart data:', error);
      setDentalChart(null);
    }
  };

  const fetchPatientData = async () => {
    try {
      const token = localStorage.getItem('token');
      const hospitalId = patientInfo.hospitalId || localStorage.getItem('hospitalId');
      const patientId = patientInfo._id || patientInfo.id || patientInfo.patientId;

      if (!hospitalId || !patientId) {
        console.warn('Missing hospitalId or patientId, using fallback data');
        setPatientData({
          name: patientInfo.name || `${patientInfo.firstName || ''} ${patientInfo.lastName || ''}`.trim() || 'Unknown Patient',
          phone: patientInfo.phone || patientInfo.primaryNumber || patientInfo.contactNumber || 'N/A',
          age: patientInfo.age || 'N/A',
          gender: patientInfo.gender || 'N/A',
          medicalHistory: patientInfo.medicalHistory || 'No significant medical history available'
        });
        return;
      }

      const response = await fetch(
        `${import.meta.env.VITE_BACKEND_URL}/api/patients/${hospitalId}/${patientId}`,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          method: 'GET'
        }
      );

      if (response.ok) {
        const responseData = await response.json();
        let apiPatientData = null;
        if (responseData.success && responseData.data) {
          apiPatientData = responseData.data;
        } else if (responseData.data) {
          apiPatientData = responseData.data;
        } else {
          apiPatientData = responseData;
        }

        if (apiPatientData) {
          setPatientData({
            name: apiPatientData.name || 
                  `${apiPatientData.firstName || ''} ${apiPatientData.lastName || ''}`.trim() || 
                  patientInfo.name || 
                  'Unknown Patient',
            phone: apiPatientData.phone || 
                   apiPatientData.primaryNumber || 
                   apiPatientData.contactNumber || 
                   apiPatientData.phoneNumber ||
                   patientInfo.phone || 
                   patientInfo.primaryNumber || 
                   patientInfo.contactNumber ||
                   'N/A',
            age: apiPatientData.age || patientInfo.age || 'N/A',
            gender: apiPatientData.gender || patientInfo.gender || 'N/A',
            medicalHistory: apiPatientData.medicalHistory || 
                          patientInfo.medicalHistory || 
                          'No medical history available'
          });
        }
      } else {
        // Fallback to patientInfo data
        setPatientData({
          name: patientInfo.name || `${patientInfo.firstName || ''} ${patientInfo.lastName || ''}`.trim() || 'Unknown Patient',
          phone: patientInfo.phone || patientInfo.primaryNumber || patientInfo.contactNumber || 'N/A',
          age: patientInfo.age || 'N/A',
          gender: patientInfo.gender || 'N/A',
          medicalHistory: patientInfo.medicalHistory || 'Unable to load medical history'
        });
      }
    } catch (error) {
      console.error('Error fetching patient data:', error);
      // Fallback to patientInfo data
      setPatientData({
        name: patientInfo.name || `${patientInfo.firstName || ''} ${patientInfo.lastName || ''}`.trim() || 'Unknown Patient',
        phone: patientInfo.phone || patientInfo.primaryNumber || patientInfo.contactNumber || 'N/A',
        age: patientInfo.age || 'N/A',
        gender: patientInfo.gender || 'N/A',
        medicalHistory: patientInfo.medicalHistory || 'Unable to load medical history'
      });
    }
  };

  const fetchProformaData = async () => {
    try {
      const patientId = patientInfo._id || patientInfo.id || patientInfo.patientId;

      if (!patientId) {
        setProformaData({});
        return;
      }

      const response = await fetch(
        `${import.meta.env.VITE_BACKEND_URL}/api/dentalchart/${patientId}/proforma`,
        {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        }
      );

      if (response.ok) {
        const data = await response.json();
        setProformaData(data.data || data || {});
      } else {
        setProformaData({});
      }
    } catch (error) {
      console.error('Error fetching proforma data:', error);
      setProformaData({});
    }
  };

  const fetchTreatmentData = async () => {
    try {
      const patientId = patientInfo._id || patientInfo.id || patientInfo.patientId;

      if (!patientId) {
        setTreatments([]);
        return;
      }

      const response = await fetch(
        `${import.meta.env.VITE_BACKEND_URL}/api/treatment-encounters/${patientId}`,
        {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        }
      );

      if (response.ok) {
        const data = await response.json();
        const encounterData = data.data || data;

        if (encounterData && encounterData.encounters && Array.isArray(encounterData.encounters)) {
          const formattedTreatments = encounterData.encounters.map((encounter, index) => ({
            _id: encounter._id || `treatment_${index}`,
            date: encounter.dateTime || encounter.date || new Date(),
            treatment: encounter.treatment || 'Treatment not specified',
            amount: Number(encounter.amountPaid || encounter.amount || 0),
            mode: encounter.paymentMode || encounter.mode || 'Not specified'
          }));
          setTreatments(formattedTreatments);
        } else if (Array.isArray(encounterData)) {
          const formattedTreatments = encounterData.map((encounter, index) => ({
            _id: encounter._id || `treatment_${index}`,
            date: encounter.dateTime || encounter.date || new Date(),
            treatment: encounter.treatment || 'Treatment not specified',
            amount: Number(encounter.amountPaid || encounter.amount || 0),
            mode: encounter.paymentMode || encounter.mode || 'Not specified'
          }));
          setTreatments(formattedTreatments);
        } else {
          setTreatments([]);
        }
      } else {
        setTreatments([]);
      }
    } catch (error) {
      console.error('Error fetching treatment data:', error);
      setTreatments([]);
    }
  };

  // Handle print trigger to refresh all data
  useEffect(() => {
    if (printTrigger > 0) {
      console.log('Print triggered, refreshing all medical report data...');
      fetchAllReportData();
    }
  }, [printTrigger]);

  // Initial data fetch
  useEffect(() => {
    fetchAllReportData();
  }, [patientInfo]);

  // Early return with regenerate option
  if (!validatePatientData(patientInfo)) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4 no-print">
        <div className="bg-white rounded-xl shadow-lg p-8 max-w-md w-full text-center">
          <AlertCircle className="w-12 h-12 text-red-500 mx-auto mb-4" />
          <h2 className="text-xl font-semibold text-gray-800 mb-2">No Patient Data</h2>
          <p className="text-gray-600 mb-4">No patient data available to generate report.</p>
          <button
            onClick={() => window.location.reload()}
            className="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
          >
            Regenerate Document
          </button>
        </div>
      </div>
    );
  }

  // Simplified loading state
  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4 no-print">
        <div className="bg-white rounded-xl shadow-lg p-8 text-center max-w-md w-full">
          <Loader2 className="w-8 h-8 animate-spin text-blue-500 mx-auto mb-3" />
          <p className="text-gray-600 text-base">Loading report data...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-white">
      {/* Print Styles - A4 Optimized */}
      <style jsx>{`
        @media print {
          @page {
            size: A4;
            margin: 15mm;
          }
          
          body {
            -webkit-print-color-adjust: exact;
            color-adjust: exact;
          }
          
          .print-page {
            page-break-after: always;
            min-height: 90vh;
            width: 100%;
            box-sizing: border-box;
          }
          
          .print-page:last-child {
            page-break-after: avoid;
          }
          
          .print:hidden {
            display: none !important;
          }
          
          .no-print {
            display: none !important;
          }
          
          /* Hide browser headers/footers content */
          .print-hide-title {
            display: none !important;
          }
        }
        
        .print-page {
          background: white;
          padding: 1rem;
          margin-bottom: 2rem;
        }
        
        @media screen {
          .print-page {
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            max-width: 210mm;
            margin: 0 auto 2rem auto;
          }
        }
      `}</style>

      {/* Success/Error Messages */}
      {message.text && (
        <div className={`fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm no-print ${
          message.type === 'error' 
            ? 'bg-red-50 border border-red-200 text-red-700' 
            : 'bg-green-50 border border-green-200 text-green-700'
        }`}>
          <div className="flex items-center space-x-2">
            <AlertCircle className="w-5 h-5 flex-shrink-0" />
            <span className="text-sm font-medium">{message.text}</span>
          </div>
        </div>
      )}

      {/* PAGE 1: Patient Information and Consent */}
      <div className="print-page">
        {/* Header Section - Dynamic */}
        <div className="text-center mb-6">
          <h1 className="text-2xl font-bold text-gray-900 mb-2">
            {hospitalData.name || 'Dental Clinic'}
          </h1>
          <p className="text-base text-gray-600">Comprehensive Medical Report</p>
          {hospitalData.address && (
            <p className="text-sm text-gray-500 mt-1">{hospitalData.address}</p>
          )}
          {hospitalData.phone && (
            <p className="text-sm text-gray-500">Contact: {hospitalData.phone}</p>
          )}
        </div>

        {/* Patient Information Section */}
        <div className="">
          <div className="flex items-center ">
            <User className="w-5 h-5 text-blue-600 mr-2" />
            <h2 className="text-lg font-semibold text-gray-900">Patient Information</h2>
          </div>
          
          {/* Date and Patient ID Row */}
          <div className="flex justify-between items-center mb-4">
            <div className="flex items-center space-x-2">
              <label className="text-gray-600 font-medium text-sm">Date:</label>
              <div className="border-b border-gray-300 w-32 h-6 text-center">
                <span className="text-sm">{(() => {
                  const today = new Date();
                  const day = String(today.getDate()).padStart(2, '0');
                  const month = String(today.getMonth() + 1).padStart(2, '0');
                  const year = today.getFullYear();
                  return `${day}-${month}-${year}`;
                })()}</span>
              </div>
            </div>
            <div className="flex items-center space-x-2">
              <label className="text-gray-600 font-medium text-sm">Patient ID:</label>
              <div className="border-b border-gray-300 w-24 h-6 text-center">
                <span className="text-sm">{patientInfo.patientId || patientInfo.id || ''}</span>
              </div>
            </div>
          </div>

          {/* Patient Name */}
          <div className="flex items-center space-x-2 mb-4">
            <label className="text-gray-600 font-medium text-sm">Patient Name:</label>
            <div className="border-b text-gray-600 border-gray-300 flex-1 h-6">
              <span className="text-sm">{patientData.name || ''}</span>
            </div>
          </div>

          {/* Age and Gender Row */}
          <div className="flex justify-between items-center mb-4">
            <div className="flex items-center space-x-2">
              <label className="text-gray-600 font-medium text-sm">Age:</label>
              <div className="border-b border-gray-300 text-sm text-gray-600 w-32 h-6 text-center">
                <span>{patientData.age || '-'}</span>
              </div>
            </div>
            <div className="flex items-center space-x-2">
              <label className="text-gray-600 font-medium text-sm">Gender:</label>
              <div className="border-b text-center border-gray-300 w-24 h-6">
                <span className="text-sm">{patientData.gender || ''}</span>
              </div>
            </div>
          </div>

          {/* Phone Number */}
          <div className="flex items-center space-x-2 mb-6">
            <label className="text-gray-600 font-medium text-sm">Phone Number:</label>
            <div className="border-b border-gray-300 w-48 h-6 text-center">
              <span className="text-sm">{getPatientPhoneNumber()}</span>
            </div>
          </div>

          <hr className="border-gray-300 mb-4" />

          {/* Medical Information Fields - Compact */}
          <div className="space-y-4">
            {/* Medical History */}
            <div>
              <label className="text-gray-600 font-medium block mb-1 text-sm">Medical History:</label>
              <div className="min-h-12 pb-1">
                <span className="text-gray-700 text-sm ml-8">
                  {getPatientMedicalHistory()}
                </span>
              </div>
            </div>
            
            <div>
              <label className="text-gray-600 font-medium block mb-1 text-sm">Chief Complaint:</label>
              <div className="min-h-12 pb-1">
                <span className="text-gray-700 text-sm ml-8">
                  {proformaData.chiefComplaint || ' '} 
                </span>
              </div>
            </div>
            
            <div>
              <label className="text-gray-600 font-medium block mb-1 text-sm">Clinical Features:</label>
              <div className="min-h-12 pb-1">
                <span className="text-gray-700 text-sm ml-8">
                  {proformaData.clinicalFeatures || ' '} 
                </span>
              </div>
            </div>
            
            <div>
              <label className="text-gray-600 font-medium block mb-1 text-sm">Diagnosis:</label>
              <div className="min-h-12 pb-1">
                <span className="text-gray-700 text-sm ml-8">
                  {proformaData.diagnosis || ' '} 
                </span>
              </div>
            </div>
            
            <div>
              <label className="text-gray-600 font-medium block mb-1 text-sm">Investigations:</label>
              <div className="min-h-12 pb-1">
                <span className="text-gray-700 text-sm ml-8">
                  {proformaData.investigations || proformaData.investigationComment || ' '} 
                </span>
              </div>
            </div>
          </div>
        </div>

        {/* Consent Section - Positioned to fit A4 */}
        <div className=" mt-[20px]">
          <h6 className='text-center text-lg mb-2'>CONSENT FOR TREATMENT</h6>

          <div className="text-gray-700 text-sm leading-relaxed mb-5 text-justify">
            I hereby give my consent to the Doctor at {hospitalData.name || 'this clinic'} to administer any treatment and to 
            administer such anaesthesia and to perform such procedures as may be deemed necessary in the 
            diagnosis and treatment of my case. I acknowledge that I have been informed of the risks and possible 
            consequences of the treatment proposed and do authorise doctors to proceed. Anything that I do not 
            understand has been explained to me clearly.
          </div>
          
          <div className="flex justify-between items-end mt-10">
            <div className="text-center">
              <div className="text-gray-600 font-medium text-sm">Date:</div>
            </div>
            <div className="text-center">
              <div className="text-xs text-gray-600">Signature of Patient/Guardian</div>
            </div>
            <div className="text-center">
              <div className="text-xs text-gray-600">Signature of Doctor</div>
            </div>
          </div>
        </div>
      </div>

      {/* PAGE 2: Dental Chart */}
      {dentalChart && (
        <div className="print-page">
          <DentalChartViewer 
            patientId={patientInfo._id || patientInfo.id || patientInfo.patientId}
            printTrigger={printTrigger} 
          />
        </div>
      )}

      {/* PAGE 3: Treatment Information */}
      {treatments.length > 0 && (
        <div className="print-page">
          <div className="mb-4">
            <h2 className="text-lg font-bold text-gray-800 mb-2">Treatment History</h2>
          </div>

          <div className="overflow-hidden border border-gray-300 rounded-lg mb-4">
            <table className="w-full border-collapse text-xs">
              <thead>
                <tr className="bg-gray-100">
                  <th className="border border-gray-300 px-2 py-2 text-left font-semibold">S.No</th>
                  <th className="border border-gray-300 px-2 py-2 text-left font-semibold">Date & Time</th>
                  <th className="border border-gray-300 px-3 py-2 text-left font-semibold">Treatment</th>
                  <th className="border border-gray-300 px-2 py-2 text-left font-semibold">Amount Paid</th>
                  <th className="border border-gray-300 px-2 py-2 text-left font-semibold">Payment Mode</th>
                </tr>
              </thead>
              <tbody>
                {treatments.map((treatment, index) => (
                  <tr key={treatment._id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                    <td className="border border-gray-300 px-2 py-2">{index + 1}</td>
                    <td className="border border-gray-300 px-2 py-2">
                      {(() => {
                        const date = new Date(treatment.date);
                        const day = String(date.getDate()).padStart(2, "0");
                        const month = String(date.getMonth() + 1).padStart(2, "0");
                        const year = date.getFullYear();
                        let hours = date.getHours();
                        const minutes = String(date.getMinutes()).padStart(2, "0");
                        const ampm = hours >= 12 ? "PM" : "AM";
                        hours = hours % 12 || 12;
                        return `${day}-${month}-${year} ${hours}:${minutes} ${ampm}`;
                      })()}
                    </td>
                    <td className="border border-gray-300 px-3 py-2">{treatment.treatment}</td>
                    <td className="border border-gray-300 px-2 py-2 font-medium">{treatment.amount}</td>
                    <td className="border border-gray-300 px-2 py-2">
                      <span className="inline-block px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium">
                        {treatment.mode}
                      </span>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Error Display with Regenerate Option */}
      {error && (
        <div className="fixed bottom-6 right-6 bg-red-50 border border-red-200 text-red-700 p-4 rounded-lg shadow-lg max-w-sm no-print">
          <div className="flex items-center space-x-2 mb-2">
            <AlertCircle className="w-5 h-5 flex-shrink-0" />
            <span className="text-sm font-medium">{error}</span>
          </div>
          <button
            onClick={() => {
              setError('');
              setLoading(false);
              setTimeout(() => {
                fetchAllReportData();
              }, 100);
            }}
            className="w-full mt-2 px-4 py-2 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition-colors"
          >
            Regenerate Document
          </button>
        </div>
      )}
    </div>
  );
};

export default MedicalReportPDF;